name: CI-CD to Azure VM (three-tier)

on:
  push:
    branches: ["main"]   # شغّليه لما تدفعي على main
  workflow_dispatch:      # ويدويًا من GitHub

jobs:
  build-test-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) اسحبي الكود من الريبو
      - name: Checkout repository
        uses: actions/checkout@v5

      # 2) backend build/test
      - name: Install and test backend
        working-directory: ./backend
        run: |
          npm install
          npm test --if-present

      # 3) frontend build/test
      - name: Install and build frontend
        working-directory: ./frontend
        run: |
          npm install
          npm run build --if-present

      # 4) (اختياري) لو تبغين Azure login
      # لازم تحطين هذي في Secrets:
      # AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID
      # - name: Azure Login
      #   uses: azure/login@v1
      #   with:
      #     client-id: ${{ secrets.AZURE_CLIENT_ID }}
      #     tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      #     subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # 5) اتصلي على الـ VM وشغّلي docker compose من الـ root
      - name: Deploy to Azure VM via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.AZURE_VM_HOST }}          # IP أو DNS للـ VM
          username: ${{ secrets.AZURE_VM_USERNAME }}  # مثال: azureuser
          key: ${{ secrets.AZURE_VM_SSH_KEY }}        # الـ private key
          port: ${{ secrets.AZURE_VM_PORT || 22 }}
          script: |
            set -e

            # روحي لمجلد التطبيق اللي كلّناه أول مرة على الـ VM
            cd ${{ secrets.AZURE_VM_APP_DIR }}

            echo "Pulling latest code from GitHub..."
            git fetch --all
            git reset --hard origin/main

            # نتأكد أي docker compose موجود
            if command -v docker compose >/dev/null 2>&1; then
              DC="docker compose"
            else
              DC="docker-compose"
            fi

            echo "Stopping old containers..."
            $DC down --remove-orphans || true

            echo "Building & starting new containers..."
            # ملاحظة: docker-compose.yml الآن في ROOT
            $DC up -d --build

            echo "Containers running:"
            docker ps -a
